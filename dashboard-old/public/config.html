<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Configuration - Ollama Assistant</title>
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <div class="app-container">
      <aside class="sidebar">
        <div class="sidebar-header">
          <a href="/" class="sidebar-logo">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M12 2L2 7l10 5 10-5-10-5z" />
              <path d="M2 17l10 5 10-5" />
              <path d="M2 12l10 5 10-5" />
            </svg>
            Ollama Assistant
          </a>
        </div>
        <nav>
          <ul class="sidebar-nav">
            <li>
              <a href="/">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <rect x="3" y="3" width="7" height="7" />
                  <rect x="14" y="3" width="7" height="7" />
                  <rect x="14" y="14" width="7" height="7" />
                  <rect x="3" y="14" width="7" height="7" />
                </svg>
                Dashboard
              </a>
            </li>
            <li>
              <a href="/personas">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                  <circle cx="12" cy="7" r="4" />
                </svg>
                Personas
              </a>
            </li>
            <li>
              <a href="/memory">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                </svg>
                Memory
              </a>
            </li>
            <li>
              <a href="/workers">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
                  <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
                </svg>
                Workers
              </a>
            </li>
            <li>
              <a href="/trackers">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                  />
                </svg>
                Trackers
              </a>
            </li>
            <li>
              <a href="/logs">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                  <polyline points="14 2 14 8 20 8" />
                  <line x1="16" y1="13" x2="8" y2="13" />
                  <line x1="16" y1="17" x2="8" y2="17" />
                  <polyline points="10 9 9 9 8 9" />
                </svg>
                Logs
              </a>
            </li>
            <li>
              <a href="/apis">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M18 20V10" />
                  <path d="M12 20V4" />
                  <path d="M6 20v-6" />
                </svg>
                APIs
              </a>
            </li>
            <li>
              <a href="/chat">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                  />
                </svg>
                Chat
              </a>
            </li>
            <li>
              <a href="/config" class="active">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="12" cy="12" r="3" />
                  <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                  />
                </svg>
                Config
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      <main class="main-content">
        <div class="page-header">
          <h1 class="page-title">Configuration</h1>
          <p class="page-subtitle">Manage system settings</p>
        </div>

        <div class="action-bar">
          <div></div>
          <div style="display: flex; gap: 10px">
            <button class="btn btn-secondary" onclick="exportConfig()">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                width="18"
                height="18"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
              </svg>
              Export
            </button>
            <button class="btn btn-danger" onclick="resetConfig()">
              Reset to Defaults
            </button>
          </div>
        </div>

        <div class="tabs" id="config-tabs">
          <button class="tab active" data-section="ollama">Ollama</button>
          <button class="tab" data-section="models">Models</button>
          <button class="tab" data-section="telegram">Telegram</button>
          <button class="tab" data-section="heartbeat">Heartbeat</button>
          <button class="tab" data-section="paths">Paths</button>
        </div>

        <div id="config-content">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </main>
    </div>

    <script type="module">
      import { api, configApi } from '/js/api.js';
      import {
        format,
        toast,
        initPage,
        setLoading,
        downloadData,
      } from '/js/shared.js';

      initPage('config');

      const configContent = document.getElementById('config-content');
      let currentConfig = {};
      let currentSection = 'ollama';

      async function loadConfig() {
        try {
          const { config } = await configApi.get();
          currentConfig = config;
          renderCurrentSection();
        } catch (error) {
          console.error('Failed to load config:', error);
          configContent.innerHTML =
            '<p class="text-muted" style="text-align: center; padding: 40px;">Failed to load configuration</p>';
        }
      }

      function renderCurrentSection() {
        let html = '';

        switch (currentSection) {
          case 'ollama':
            html = renderOllamaSection();
            break;
          case 'models':
            html = renderModelsSection();
            break;
          case 'telegram':
            html = renderTelegramSection();
            break;
          case 'heartbeat':
            html = renderHeartbeatSection();
            break;
          case 'paths':
            html = renderPathsSection();
            break;
        }

        configContent.innerHTML = html;
      }

      function renderOllamaSection() {
        const ollama = currentConfig.ollama || {};
        return `
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Ollama Server</h3>
            <button class="btn btn-sm btn-primary" onclick="saveSection('ollama')">Save Changes</button>
          </div>
          <div class="grid grid-2">
            <div class="form-group">
              <label class="form-label">Base URL</label>
              <input type="text" class="form-input" id="ollama-baseUrl" value="${ollama.baseUrl || 'http://localhost:11434'}">
            </div>
            <div class="form-group">
              <label class="form-label">Timeout (ms)</label>
              <input type="number" class="form-input" id="ollama-timeout" value="${ollama.timeout || 120000}">
            </div>
          </div>
        </div>
      `;
      }

      function renderModelsSection() {
        const models = currentConfig.models?.defaults || {};
        return `
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Default Models</h3>
            <button class="btn btn-sm btn-primary" onclick="saveSection('models')">Save Changes</button>
          </div>
          <div class="grid grid-2">
            <div class="form-group">
              <label class="form-label">General Purpose</label>
              <input type="text" class="form-input" id="models-general" value="${models.general || 'ollama/llama3.2'}">
            </div>
            <div class="form-group">
              <label class="form-label">Coding</label>
              <input type="text" class="form-input" id="models-coding" value="${models.coding || 'ollama/qwen3-coder:latest'}">
            </div>
            <div class="form-group">
              <label class="form-label">Analysis</label>
              <input type="text" class="form-input" id="models-analysis" value="${models.analysis || 'ollama/deepseek-r1:32b'}">
            </div>
            <div class="form-group">
              <label class="form-label">Vision</label>
              <input type="text" class="form-input" id="models-vision" value="${models.vision || 'ollama/llava'}">
            </div>
          </div>
        </div>
      `;
      }

      function renderTelegramSection() {
        const telegram = currentConfig.telegram || {};
        return `
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Telegram Bot</h3>
            <button class="btn btn-sm btn-primary" onclick="saveSection('telegram')">Save Changes</button>
          </div>
          <div class="form-group">
            <label class="form-label">
              <input type="checkbox" id="telegram-enabled" ${telegram.enabled ? 'checked' : ''}>
              Enable Telegram Bot
            </label>
          </div>
          <div class="form-group">
            <label class="form-label">Bot Token</label>
            <input type="password" class="form-input" id="telegram-botToken" value="${telegram.botToken || ''}" placeholder="Enter bot token">
          </div>
        </div>
      `;
      }

      function renderHeartbeatSection() {
        const heartbeat = currentConfig.heartbeat || {};
        return `
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Heartbeat Monitor</h3>
            <button class="btn btn-sm btn-primary" onclick="saveSection('heartbeat')">Save Changes</button>
          </div>
          <div class="form-group">
            <label class="form-label">
              <input type="checkbox" id="heartbeat-enabled" ${heartbeat.enabled !== false ? 'checked' : ''}>
              Enable Heartbeat Monitoring
            </label>
          </div>
          <div class="grid grid-2">
            <div class="form-group">
              <label class="form-label">Check Interval (ms)</label>
              <input type="number" class="form-input" id="heartbeat-intervalMs" value="${heartbeat.intervalMs || 1800000}">
            </div>
            <div class="form-group">
              <label class="form-label">Quiet Hours Start</label>
              <input type="time" class="form-input" id="heartbeat-quietHours-start" value="${heartbeat.quietHours?.start || '23:00'}">
            </div>
            <div class="form-group">
              <label class="form-label">Quiet Hours End</label>
              <input type="time" class="form-input" id="heartbeat-quietHours-end" value="${heartbeat.quietHours?.end || '08:00'}">
            </div>
          </div>
        </div>
      `;
      }

      function renderPathsSection() {
        const paths = currentConfig.paths || {};
        return `
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">File Paths</h3>
            <button class="btn btn-sm btn-primary" onclick="saveSection('paths')">Save Changes</button>
          </div>
          <div class="form-group">
            <label class="form-label">Config Directory</label>
            <input type="text" class="form-input" id="paths-configDir" value="${paths.configDir || ''}" readonly style="background: var(--bg-tertiary);">
          </div>
          <div class="form-group">
            <label class="form-label">Workspaces Directory</label>
            <input type="text" class="form-input" id="paths-workspacesDir" value="${paths.workspacesDir || ''}" readonly style="background: var(--bg-tertiary);">
          </div>
          <div class="form-group">
            <label class="form-label">Memory Directory</label>
            <input type="text" class="form-input" id="paths-memoryDir" value="${paths.memoryDir || ''}" readonly style="background: var(--bg-tertiary);">
          </div>
        </div>
      `;
      }

      window.saveSection = async (section) => {
        let updates = {};

        switch (section) {
          case 'ollama':
            updates = {
              ollama: {
                baseUrl: document.getElementById('ollama-baseUrl').value,
                timeout: parseInt(
                  document.getElementById('ollama-timeout').value,
                ),
              },
            };
            break;
          case 'models':
            updates = {
              models: {
                defaults: {
                  general: document.getElementById('models-general').value,
                  coding: document.getElementById('models-coding').value,
                  analysis: document.getElementById('models-analysis').value,
                  vision: document.getElementById('models-vision').value,
                },
              },
            };
            break;
          case 'telegram':
            updates = {
              telegram: {
                enabled: document.getElementById('telegram-enabled').checked,
                botToken: document.getElementById('telegram-botToken').value,
              },
            };
            break;
          case 'heartbeat':
            updates = {
              heartbeat: {
                enabled: document.getElementById('heartbeat-enabled').checked,
                intervalMs: parseInt(
                  document.getElementById('heartbeat-intervalMs').value,
                ),
                quietHours: {
                  start: document.getElementById('heartbeat-quietHours-start')
                    .value,
                  end: document.getElementById('heartbeat-quietHours-end')
                    .value,
                },
              },
            };
            break;
        }

        try {
          // Merge updates with current config
          const newConfig = { ...currentConfig, ...updates };
          await configApi.update(newConfig);
          toast.success('Configuration saved');
          loadConfig();
        } catch (error) {
          toast.error('Failed to save configuration');
        }
      };

      window.exportConfig = async () => {
        try {
          const { config } = await configApi.get();
          downloadData(config, 'config.json');
          toast.success('Configuration exported');
        } catch (error) {
          toast.error('Failed to export configuration');
        }
      };

      window.resetConfig = async () => {
        if (
          !confirm(
            'Reset all configuration to defaults? This cannot be undone.',
          )
        )
          return;

        try {
          await configApi.reset();
          toast.success('Configuration reset to defaults');
          loadConfig();
        } catch (error) {
          toast.error('Failed to reset configuration');
        }
      };

      // Tab switching
      document.querySelectorAll('#config-tabs .tab').forEach((tab) => {
        tab.addEventListener('click', () => {
          document
            .querySelectorAll('#config-tabs .tab')
            .forEach((t) => t.classList.remove('active'));
          tab.classList.add('active');
          currentSection = tab.dataset.section;
          renderCurrentSection();
        });
      });

      // Listen for real-time updates
      api.on('configUpdated', () => {
        loadConfig();
      });
      api.on('configReset', () => {
        loadConfig();
      });

      // Initial load
      loadConfig();
    </script>
  </body>
</html>
