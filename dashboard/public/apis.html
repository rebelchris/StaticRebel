<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Connectors - Ollama Assistant</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="/" class="sidebar-logo">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="M2 17l10 5 10-5"/>
            <path d="M2 12l10 5 10-5"/>
          </svg>
          Ollama Assistant
        </a>
      </div>
      <nav>
        <ul class="sidebar-nav">
          <li><a href="/">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7"/>
              <rect x="14" y="3" width="7" height="7"/>
              <rect x="14" y="14" width="7" height="7"/>
              <rect x="3" y="14" width="7" height="7"/>
            </svg>
            Dashboard
          </a></li>
          <li><a href="/personas">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
            Personas
          </a></li>
          <li><a href="/memory">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
            Memory
          </a></li>
          <li><a href="/workers">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
              <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
            </svg>
            Workers
          </a></li>
          <li><a href="/apis" class="active">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 20V10"/>
              <path d="M12 20V4"/>
              <path d="M6 20v-6"/>
            </svg>
            APIs
          </a></li>
          <li><a href="/chat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            Chat
          </a></li>
          <li><a href="/config">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
            Config
          </a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content">
      <div class="page-header">
        <h1 class="page-title">API Connectors</h1>
        <p class="page-subtitle">Manage external API integrations</p>
      </div>

      <div class="grid grid-4" id="stats-grid">
        <div class="loading"><div class="spinner"></div></div>
      </div>

      <div class="action-bar" style="margin-top: 20px;">
        <div></div>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-secondary" onclick="openModal('add-common-modal')">
            Add Common Service
          </button>
          <button class="btn btn-primary" onclick="openModal('create-connector-modal')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            New Connector
          </button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Connectors</h3>
        </div>
        <div id="connectors-list">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>
    </main>
  </div>

  <!-- Create Connector Modal -->
  <div class="modal-overlay" id="create-connector-modal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3 class="modal-title">Create API Connector</h3>
        <button class="modal-close" onclick="closeModal('create-connector-modal')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="create-connector-form">
          <div class="grid grid-2">
            <div class="form-group">
              <label class="form-label">Name</label>
              <input type="text" class="form-input" name="name" required placeholder="e.g., Weather API">
            </div>
            <div class="form-group">
              <label class="form-label">Type</label>
              <select class="form-select" name="type">
                <option value="rest">REST API</option>
                <option value="graphql">GraphQL</option>
                <option value="webhook">Webhook</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Base URL</label>
            <input type="url" class="form-input" name="baseUrl" required placeholder="https://api.example.com">
          </div>
          <div class="form-group">
            <label class="form-label">Description</label>
            <input type="text" class="form-input" name="description" placeholder="Optional description">
          </div>
          <div class="form-group">
            <label class="form-label">Authentication Type</label>
            <select class="form-select" name="authType">
              <option value="none">None</option>
              <option value="apikey">API Key</option>
              <option value="bearer">Bearer Token</option>
              <option value="basic">Basic Auth</option>
              <option value="oauth2">OAuth 2.0</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('create-connector-modal')">Cancel</button>
        <button class="btn btn-primary" id="create-connector-btn">Create</button>
      </div>
    </div>
  </div>

  <!-- Add Common Service Modal -->
  <div class="modal-overlay" id="add-common-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Common Service</h3>
        <button class="modal-close" onclick="closeModal('add-common-modal')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div style="display: grid; gap: 12px;">
          <button class="btn btn-secondary" style="justify-content: flex-start;" onclick="addCommonService('weather')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
              <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/>
              <circle cx="12" cy="12" r="4"/>
            </svg>
            Weather API (OpenWeatherMap)
          </button>
          <button class="btn btn-secondary" style="justify-content: flex-start;" onclick="addCommonService('news')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
              <path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/>
              <path d="M18 14h-8M15 18h-6M10 6h8v4h-8V6Z"/>
            </svg>
            News API
          </button>
          <button class="btn btn-secondary" style="justify-content: flex-start;" onclick="addCommonService('spotify')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
              <path d="M12 19c-4.2 0-7.5-2.8-8-7a8.5 8.5 0 0 1 6-6c.3.5.7 1 1.2 1.4a7.5 7.5 0 0 0 10.6 0c.5-.4.9-.9 1.2-1.4.5 4.2-3.3 7-8 7Zm0-11c-3.3 0-6 2.2-6.5 5.3a6 6 0 0 1 10.4-2.8A5.5 5.5 0 0 0 12 8Zm0 9.5a3 3 0 1 1 0-6 3 3 0 0 1 0 6Z"/>
            </svg>
            Spotify API
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('add-common-modal')">Cancel</button>
      </div>
    </div>
  </div>

  <!-- API Key Modal -->
  <div class="modal-overlay" id="api-key-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Set API Key</h3>
        <button class="modal-close" onclick="closeModal('api-key-modal')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="api-key-connector-id">
        <div class="form-group">
          <label class="form-label">API Key</label>
          <input type="password" class="form-input" id="api-key-input" placeholder="Enter your API key">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('api-key-modal')">Cancel</button>
        <button class="btn btn-primary" id="save-api-key-btn">Save</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { api, connectorsApi } from '/js/api.js';
    import { format, toast, initPage, setLoading } from '/js/shared.js';

    initPage('apis');

    const statsGrid = document.getElementById('stats-grid');
    const connectorsList = document.getElementById('connectors-list');
    const createConnectorBtn = document.getElementById('create-connector-btn');
    const saveApiKeyBtn = document.getElementById('save-api-key-btn');
    let currentConnectors = [];

    async function loadStats() {
      try {
        const { stats } = await connectorsApi.getAll();
        renderStats(stats);
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }

    function renderStats(stats) {
      statsGrid.innerHTML = `
        <div class="stat-card">
          <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 20V10"/>
              <path d="M12 20V4"/>
              <path d="M6 20v-6"/>
            </svg>
          </div>
          <div class="stat-content">
            <div class="stat-value">${stats.totalConnectors || 0}</div>
            <div class="stat-label">Total Connectors</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: white;">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
              <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
          </div>
          <div class="stat-content">
            <div class="stat-value">${stats.activeConnectors || 0}</div>
            <div class="stat-label">Active</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
          </div>
          <div class="stat-content">
            <div class="stat-value">${stats.byAuthType?.apikey || 0}</div>
            <div class="stat-label">API Key Auth</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
              <line x1="8" y1="21" x2="16" y2="21"/>
              <line x1="12" y1="17" x2="12" y2="21"/>
            </svg>
          </div>
          <div class="stat-content">
            <div class="stat-value">${stats.byType?.rest || 0}</div>
            <div class="stat-label">REST APIs</div>
          </div>
        </div>
      `;
    }

    async function loadConnectors() {
      connectorsList.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

      try {
        const { connectors } = await connectorsApi.getAll();
        currentConnectors = connectors;
        renderConnectors(connectors);
      } catch (error) {
        console.error('Failed to load connectors:', error);
        connectorsList.innerHTML = '<p class="text-muted" style="text-align: center; padding: 40px;">Failed to load connectors</p>';
      }
    }

    function renderConnectors(connectors) {
      if (connectors.length === 0) {
        connectorsList.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 20V10"/>
              <path d="M12 20V4"/>
              <path d="M6 20v-6"/>
            </svg>
            <h3>No connectors yet</h3>
            <p>Create your first API connector</p>
          </div>
        `;
        return;
      }

      connectorsList.innerHTML = `
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Auth</th>
                <th>Base URL</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${connectors.map(c => `
                <tr>
                  <td>
                    <div style="font-weight: 500;">${c.name}</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">${c.description || ''}</div>
                  </td>
                  <td><span class="badge badge-info">${c.type || 'rest'}</span></td>
                  <td><span class="badge badge-primary">${c.authType || 'none'}</span></td>
                  <td style="font-size: 0.8rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${c.baseUrl || '-'}
                  </td>
                  <td>
                    <span class="badge ${c.status === 'active' ? 'badge-success' : 'badge-warning'}">
                      ${c.status || 'unknown'}
                    </span>
                  </td>
                  <td style="font-size: 0.85rem; color: var(--text-secondary);">${format.relativeTime(c.createdAt)}</td>
                  <td>
                    <div style="display: flex; gap: 6px;">
                      <button class="btn btn-sm btn-secondary" onclick="testConnector('${c.id}')">Test</button>
                      <button class="btn btn-sm btn-secondary" onclick="showApiKeyModal('${c.id}')">Key</button>
                      <button class="btn btn-sm btn-danger" onclick="deleteConnector('${c.id}')">Delete</button>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // Create connector
    createConnectorBtn.addEventListener('click', async () => {
      const form = document.getElementById('create-connector-form');
      const formData = new FormData(form);

      const data = {
        name: formData.get('name'),
        type: formData.get('type'),
        baseUrl: formData.get('baseUrl'),
        description: formData.get('description'),
        authType: formData.get('authType')
      };

      setLoading(createConnectorBtn, true);
      try {
        await connectorsApi.create(data);
        toast.success('Connector created');
        closeModal('create-connector-modal');
        form.reset();
        loadStats();
        loadConnectors();
      } catch (error) {
        toast.error('Failed to create connector');
      } finally {
        setLoading(createConnectorBtn, false);
      }
    });

    // Add common service
    window.addCommonService = async (service) => {
      try {
        await connectorsApi.createCommon(service);
        toast.success('Connector created');
        closeModal('add-common-modal');
        loadStats();
        loadConnectors();
      } catch (error) {
        toast.error('Failed to create connector');
      }
    };

    // Test connector
    window.testConnector = async (id) => {
      try {
        const result = await connectorsApi.test(id);
        if (result.success) {
          toast.success(`Connection successful! Latency: ${result.latency}ms`);
        } else {
          toast.error(result.error || 'Connection failed');
        }
      } catch (error) {
        toast.error('Test failed');
      }
    };

    // Show API key modal
    window.showApiKeyModal = (id) => {
      document.getElementById('api-key-connector-id').value = id;
      document.getElementById('api-key-input').value = '';
      openModal('api-key-modal');
    };

    // Save API key
    saveApiKeyBtn.addEventListener('click', async () => {
      const id = document.getElementById('api-key-connector-id').value;
      const apiKey = document.getElementById('api-key-input').value;

      if (!apiKey) {
        toast.error('Please enter an API key');
        return;
      }

      setLoading(saveApiKeyBtn, true);
      try {
        await connectorsApi.setKey(id, apiKey);
        toast.success('API key saved');
        closeModal('api-key-modal');
      } catch (error) {
        toast.error('Failed to save API key');
      } finally {
        setLoading(saveApiKeyBtn, false);
      }
    });

    // Delete connector
    window.deleteConnector = async (id) => {
      if (!confirm('Are you sure you want to delete this connector?')) return;

      try {
        await connectorsApi.delete(id);
        toast.success('Connector deleted');
        loadStats();
        loadConnectors();
      } catch (error) {
        toast.error('Failed to delete connector');
      }
    };

    // Listen for real-time updates
    api.on('connectorCreated', () => {
      loadStats();
      loadConnectors();
    });
    api.on('connectorDeleted', () => {
      loadStats();
      loadConnectors();
    });

    // Initial load
    loadStats();
    loadConnectors();
  </script>
</body>
</html>
