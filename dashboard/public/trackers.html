<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trackers - Ollama Assistant</title>
    <link rel="stylesheet" href="/css/style.css" />
    <style>
      /* Tracker-specific styles */
      .trackers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .tracker-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 20px;
        transition: all var(--transition-normal);
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .tracker-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary-color);
      }

      .tracker-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(
          90deg,
          var(--primary-color),
          var(--info-color)
        );
      }

      .tracker-card.workout::before {
        background: linear-gradient(90deg, #f97316, #ef4444);
      }

      .tracker-card.nutrition::before {
        background: linear-gradient(90deg, #22c55e, #10b981);
      }

      .tracker-card.sleep::before {
        background: linear-gradient(90deg, #8b5cf6, #6366f1);
      }

      .tracker-card.habit::before {
        background: linear-gradient(90deg, #f59e0b, #eab308);
      }

      .tracker-card.custom::before {
        background: linear-gradient(90deg, #64748b, #94a3b8);
      }

      .tracker-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
      }

      .tracker-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        background: var(--bg-tertiary);
      }

      .tracker-info h3 {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
      }

      .tracker-info .tracker-type {
        font-size: 0.8rem;
        color: var(--text-secondary);
        text-transform: capitalize;
      }

      .tracker-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-top: 16px;
      }

      .tracker-stat {
        background: var(--bg-tertiary);
        padding: 12px;
        border-radius: 8px;
        text-align: center;
      }

      .tracker-stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
      }

      .tracker-stat-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 4px;
      }

      .tracker-metrics {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 12px;
      }

      .tracker-metric {
        background: var(--bg-tertiary);
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        color: var(--text-secondary);
      }

      .tracker-actions {
        display: flex;
        gap: 8px;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border-color);
      }

      .tracker-actions .btn {
        flex: 1;
        padding: 8px 12px;
        font-size: 0.8rem;
      }

      /* Empty state */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
      }

      .empty-state-icon {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      .empty-state h3 {
        font-size: 1.25rem;
        color: var(--text-primary);
        margin-bottom: 8px;
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: var(--bg-card);
        border-radius: var(--border-radius);
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        border: 1px solid var(--border-color);
      }

      .modal-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .modal-body {
        padding: 20px;
      }

      .modal-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 24px;
        cursor: pointer;
        padding: 4px;
        line-height: 1;
      }

      .modal-close:hover {
        color: var(--text-primary);
      }

      /* Chart container */
      .chart-container {
        background: var(--bg-tertiary);
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        height: 300px;
        position: relative;
      }

      .chart-bar {
        flex: 1;
        background: linear-gradient(
          to top,
          var(--primary-color),
          var(--info-color)
        );
        border-radius: 4px 4px 0 0;
        min-height: 5px;
        transition: all var(--transition-fast);
        cursor: pointer;
      }

      .chart-bar:hover {
        opacity: 0.8;
        transform: scaleY(1.05);
      }

      .mini-chart {
        height: 60px;
        margin-top: 12px;
        display: flex;
        align-items: flex-end;
        gap: 2px;
      }

      .mini-chart-bar {
        flex: 1;
        background: var(--primary-color);
        border-radius: 2px 2px 0 0;
        min-height: 4px;
        opacity: 0.7;
        transition: opacity var(--transition-fast);
      }

      .mini-chart-bar:hover {
        opacity: 1;
      }

      /* Records list */
      .records-list {
        max-height: 400px;
        overflow-y: auto;
      }

      .record-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid var(--border-color);
        transition: background var(--transition-fast);
      }

      .record-item:hover {
        background: var(--bg-tertiary);
      }

      .record-date {
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .record-data {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .record-data-item {
        background: var(--bg-tertiary);
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
      }

      .record-data-item strong {
        color: var(--primary-color);
      }

      /* Create tracker form */
      .form-group {
        margin-bottom: 16px;
      }

      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px 14px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        color: var(--text-primary);
        font-size: 0.95rem;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-color);
      }

      .type-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
        margin-top: 8px;
      }

      .type-option {
        background: var(--bg-tertiary);
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 16px;
        text-align: center;
        cursor: pointer;
        transition: all var(--transition-fast);
      }

      .type-option:hover {
        border-color: var(--primary-color);
      }

      .type-option.selected {
        border-color: var(--primary-color);
        background: rgba(99, 102, 241, 0.1);
      }

      .type-option .icon {
        font-size: 32px;
        margin-bottom: 8px;
      }

      .type-option .name {
        font-weight: 600;
        font-size: 0.9rem;
      }

      /* Filter tabs */
      .filter-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .filter-tab {
        padding: 8px 16px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all var(--transition-fast);
        font-size: 0.9rem;
      }

      .filter-tab:hover {
        border-color: var(--primary-color);
        color: var(--text-primary);
      }

      .filter-tab.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
      }

      /* Stats overview */
      .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 30px;
      }

      .stat-box {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 20px;
        text-align: center;
      }

      .stat-box-icon {
        font-size: 32px;
        margin-bottom: 8px;
      }

      .stat-box-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
      }

      .stat-box-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-top: 4px;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <aside class="sidebar">
        <div class="sidebar-header">
          <a href="/" class="sidebar-logo">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M12 2L2 7l10 5 10-5-10-5z" />
              <path d="M2 17l10 5 10-5" />
              <path d="M2 12l10 5 10-5" />
            </svg>
            Ollama Assistant
          </a>
        </div>
        <nav>
          <ul class="sidebar-nav">
            <li>
              <a href="/">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <rect x="3" y="3" width="7" height="7" />
                  <rect x="14" y="3" width="7" height="7" />
                  <rect x="14" y="14" width="7" height="7" />
                  <rect x="3" y="14" width="7" height="7" />
                </svg>
                Dashboard
              </a>
            </li>
            <li>
              <a href="/personas">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                  <circle cx="12" cy="7" r="4" />
                </svg>
                Personas
              </a>
            </li>
            <li>
              <a href="/memory">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                </svg>
                Memory
              </a>
            </li>
            <li>
              <a href="/workers">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
                  <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
                </svg>
                Workers
              </a>
            </li>
            <li>
              <a href="/trackers" class="active">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                  />
                </svg>
                Trackers
              </a>
            </li>
            <li>
              <a href="/logs">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                  <polyline points="14 2 14 8 20 8" />
                  <line x1="16" y1="13" x2="8" y2="13" />
                  <line x1="16" y1="17" x2="8" y2="17" />
                  <polyline points="10 9 9 9 8 9" />
                </svg>
                Logs
              </a>
            </li>
            <li>
              <a href="/apis">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M18 20V10" />
                  <path d="M12 20V4" />
                  <path d="M6 20v-6" />
                </svg>
                APIs
              </a>
            </li>
            <li>
              <a href="/chat">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                  />
                </svg>
                Chat
              </a>
            </li>
            <li>
              <a href="/config">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="12" cy="12" r="3" />
                  <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                  />
                </svg>
                Config
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      <main class="main-content">
        <div class="page-header">
          <h1 class="page-title">Trackers</h1>
          <p class="page-subtitle">
            Visualize and manage your auto-created trackers
          </p>
        </div>

        <div class="action-bar">
          <div class="filter-tabs" id="filter-tabs">
            <button class="filter-tab active" data-filter="all">All</button>
            <button class="filter-tab" data-filter="workout">Workout</button>
            <button class="filter-tab" data-filter="nutrition">
              Nutrition
            </button>
            <button class="filter-tab" data-filter="sleep">Sleep</button>
            <button class="filter-tab" data-filter="habit">Habit</button>
            <button class="filter-tab" data-filter="custom">Custom</button>
          </div>
          <button class="btn btn-primary" id="create-tracker-btn">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              style="width: 18px; height: 18px"
            >
              <line x1="12" y1="5" x2="12" y2="19" />
              <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
            Create Tracker
          </button>
        </div>

        <div class="stats-overview" id="stats-overview">
          <!-- Stats will be loaded here -->
        </div>

        <div class="trackers-grid" id="trackers-grid">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </main>
    </div>

    <!-- Tracker Detail Modal -->
    <div class="modal" id="tracker-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-title">Tracker Details</h2>
          <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-body" id="modal-body">
          <!-- Content loaded dynamically -->
        </div>
      </div>
    </div>

    <!-- Create Tracker Modal -->
    <div class="modal" id="create-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Create New Tracker</h2>
          <button class="modal-close" id="create-modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <form id="create-tracker-form">
            <div class="form-group">
              <label>Tracker Type</label>
              <div class="type-selector" id="type-selector">
                <div class="type-option" data-type="workout">
                  <div class="icon">üí™</div>
                  <div class="name">Workout</div>
                </div>
                <div class="type-option" data-type="nutrition">
                  <div class="icon">ü•ó</div>
                  <div class="name">Nutrition</div>
                </div>
                <div class="type-option" data-type="sleep">
                  <div class="icon">üò¥</div>
                  <div class="name">Sleep</div>
                </div>
                <div class="type-option" data-type="habit">
                  <div class="icon">‚úÖ</div>
                  <div class="name">Habit</div>
                </div>
                <div class="type-option" data-type="custom">
                  <div class="icon">üìä</div>
                  <div class="name">Custom</div>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="tracker-name">Short Name (for commands)</label>
              <input
                type="text"
                id="tracker-name"
                placeholder="e.g., workout, food, sleep"
                required
              />
            </div>

            <div class="form-group">
              <label for="tracker-display-name">Display Name</label>
              <input
                type="text"
                id="tracker-display-name"
                placeholder="e.g., My Workouts"
                required
              />
            </div>

            <div class="form-group">
              <label for="tracker-metrics">Metrics (comma-separated)</label>
              <input
                type="text"
                id="tracker-metrics"
                placeholder="e.g., exercise, sets, reps, weight"
              />
            </div>

            <div
              style="
                display: flex;
                gap: 12px;
                justify-content: flex-end;
                margin-top: 24px;
              "
            >
              <button
                type="button"
                class="btn btn-secondary"
                id="cancel-create"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                Create Tracker
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script type="module">
      import { api } from '/js/api.js';
      import { toast, initPage } from '/js/shared.js';

      initPage('trackers');

      const trackersGrid = document.getElementById('trackers-grid');
      const statsOverview = document.getElementById('stats-overview');
      const filterTabs = document.getElementById('filter-tabs');
      const trackerModal = document.getElementById('tracker-modal');
      const createModal = document.getElementById('create-modal');
      const modalTitle = document.getElementById('modal-title');
      const modalBody = document.getElementById('modal-body');

      let allTrackers = [];
      let currentFilter = 'all';

      // Type icons mapping
      const typeIcons = {
        workout: 'üí™',
        nutrition: 'ü•ó',
        sleep: 'üò¥',
        habit: '‚úÖ',
        custom: 'üìä',
        food: 'üçΩÔ∏è',
      };

      // Generate chart data from records (group by date)
      function generateChartData(records) {
        if (!records || records.length === 0) return [];

        // Group records by date
        const byDate = {};
        records.forEach((r) => {
          const date = r.date;
          byDate[date] = (byDate[date] || 0) + 1;
        });

        // Get last 14 days
        const dates = Object.keys(byDate).sort();
        const last14Dates = dates.slice(-14);

        return last14Dates.map((d) => byDate[d] || 0);
      }

      // Load trackers
      async function loadTrackers() {
        try {
          const response = await api.get('/trackers');
          allTrackers = response.trackers || [];
          updateStatsOverview(response.stats);
          renderTrackers();
        } catch (error) {
          console.error('Failed to load trackers:', error);
          trackersGrid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ö†Ô∏è</div>
            <h3>Failed to load trackers</h3>
            <p>${error.message}</p>
          </div>
        `;
        }
      }

      // Update stats overview
      function updateStatsOverview(stats) {
        const totalTrackers = stats?.total || 0;
        const byType = stats?.byType || {};

        statsOverview.innerHTML = `
        <div class="stat-box">
          <div class="stat-box-icon">üìä</div>
          <div class="stat-box-value">${totalTrackers}</div>
          <div class="stat-box-label">Total Trackers</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-icon">üí™</div>
          <div class="stat-box-value">${byType.workout || 0}</div>
          <div class="stat-box-label">Workout</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-icon">ü•ó</div>
          <div class="stat-box-value">${(byType.nutrition || 0) + (byType.food || 0)}</div>
          <div class="stat-box-label">Nutrition</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-icon">üò¥</div>
          <div class="stat-box-value">${byType.sleep || 0}</div>
          <div class="stat-box-label">Sleep</div>
        </div>
      `;
      }

      // Render trackers grid
      function renderTrackers() {
        const filtered =
          currentFilter === 'all'
            ? allTrackers
            : allTrackers.filter(
                (t) =>
                  t.type === currentFilter ||
                  (currentFilter === 'nutrition' && t.type === 'food'),
              );

        if (filtered.length === 0) {
          trackersGrid.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="empty-state-icon">üìä</div>
            <h3>No trackers found</h3>
            <p>${currentFilter === 'all' ? 'Create your first tracker to start tracking data.' : `No ${currentFilter} trackers found.`}</p>
          </div>
        `;
          return;
        }

        trackersGrid.innerHTML = filtered
          .map((tracker) => {
            const icon = typeIcons[tracker.type] || typeIcons.custom;
            const metrics = tracker.config?.metrics || [];
            const lastEntry = tracker.lastEntry
              ? new Date(tracker.lastEntry).toLocaleDateString()
              : 'Never';

            // Generate mini chart data (placeholder)
            const chartBars = Array(14)
              .fill(0)
              .map((_, i) => {
                const height = Math.random() * 80 + 20;
                return `<div class="mini-chart-bar" style="height: ${height}%"></div>`;
              })
              .join('');

            return `
          <div class="tracker-card ${tracker.type}" onclick="openTrackerDetail('${tracker.name}')">
            <div class="tracker-header">
              <div class="tracker-icon">${icon}</div>
              <div class="tracker-info">
                <h3>${tracker.displayName}</h3>
                <div class="tracker-type">${tracker.type} ‚Ä¢ @${tracker.name}</div>
              </div>
            </div>

            <div class="mini-chart">${chartBars}</div>

            <div class="tracker-stats">
              <div class="tracker-stat">
                <div class="tracker-stat-value">${tracker.recordCount}</div>
                <div class="tracker-stat-label">Entries</div>
              </div>
              <div class="tracker-stat">
                <div class="tracker-stat-value">${metrics.length}</div>
                <div class="tracker-stat-label">Metrics</div>
              </div>
            </div>

            <div class="tracker-metrics">
              ${metrics
                .slice(0, 4)
                .map((m) => `<span class="tracker-metric">${m}</span>`)
                .join('')}
              ${metrics.length > 4 ? `<span class="tracker-metric">+${metrics.length - 4}</span>` : ''}
            </div>

            <div class="tracker-actions" onclick="event.stopPropagation()">
              <button class="btn btn-sm btn-secondary" onclick="viewTrackerStats('${tracker.name}')">Stats</button>
              <button class="btn btn-sm btn-secondary" onclick="viewTrackerHistory('${tracker.name}')">History</button>
              <button class="btn btn-sm btn-danger" onclick="deleteTracker('${tracker.name}')">Delete</button>
            </div>
          </div>
        `;
          })
          .join('');
      }

      // Filter tabs
      filterTabs.addEventListener('click', (e) => {
        if (e.target.classList.contains('filter-tab')) {
          document
            .querySelectorAll('.filter-tab')
            .forEach((t) => t.classList.remove('active'));
          e.target.classList.add('active');
          currentFilter = e.target.dataset.filter;
          renderTrackers();
        }
      });

      // Open tracker detail
      window.openTrackerDetail = async (name) => {
        try {
          const response = await api.get(`/trackers/${name}`);
          const tracker = response.tracker;
          const records = response.records || [];

          modalTitle.innerHTML = `${typeIcons[tracker.type] || typeIcons.custom} ${tracker.displayName}`;

          const recentRecords = records
            .slice(-5)
            .reverse()
            .map((record) => {
              const dataItems = Object.entries(record.data || {})
                .map(
                  ([key, value]) =>
                    `<span class="record-data-item"><strong>${key}:</strong> ${value}</span>`,
                )
                .join('');

              return `
            <div class="record-item">
              <span class="record-date">${new Date(record.date).toLocaleDateString()}</span>
              <div class="record-data">${dataItems}</div>
            </div>
          `;
            })
            .join('');

          modalBody.innerHTML = `
          <div style="margin-bottom: 20px;">
            <strong>Type:</strong> ${tracker.type}<br>
            <strong>Name:</strong> @${tracker.name}<br>
            <strong>Created:</strong> ${new Date(tracker.createdAt).toLocaleDateString()}<br>
            <strong>Total Records:</strong> ${records.length}
          </div>

          <h3 style="margin: 20px 0 12px;">Metrics</h3>
          <div class="tracker-metrics" style="margin-bottom: 20px;">
            ${(tracker.config?.metrics || []).map((m) => `<span class="tracker-metric">${m}</span>`).join('')}
          </div>

          <h3 style="margin: 20px 0 12px;">Recent Entries</h3>
          <div class="records-list">
            ${recentRecords || '<p style="color: var(--text-secondary);">No entries yet.</p>'}
          </div>

          <div style="margin-top: 20px; display: flex; gap: 12px;">
            <button class="btn btn-primary" onclick="viewTrackerStats('${tracker.name}')">View Full Stats</button>
            <button class="btn btn-secondary" onclick="viewTrackerHistory('${tracker.name}')">View All History</button>
          </div>
        `;

          trackerModal.classList.add('active');
        } catch (error) {
          toast.error('Failed to load tracker details');
        }
      };

      // View tracker stats
      window.viewTrackerStats = async (name) => {
        try {
          const response = await api.get(`/trackers/${name}/stats?period=week`);

          modalTitle.innerHTML = `üìä Stats for ${name}`;

          if (response.error) {
            modalBody.innerHTML = `<p style="color: var(--danger-color);">${response.error}</p>`;
          } else if (response.totalEntries === 0) {
            modalBody.innerHTML = `<p>No entries found for this period.</p>`;
          } else {
            const aggregations = Object.entries(response.aggregations || {})
              .map(
                ([metric, data]) => `
              <div class="stat-box">
                <div class="stat-box-value">${data.average?.toFixed(1) || 'N/A'}</div>
                <div class="stat-box-label">Avg ${metric}</div>
              </div>
            `,
              )
              .join('');

            // Generate bar chart from records
            const records = response.records || [];
            const chartData = generateChartData(records);
            const chartBars = chartData
              .map((val, i) => {
                const height = Math.max(
                  5,
                  (val / Math.max(...chartData)) * 100,
                );
                return `<div class="chart-bar" style="height: ${height}%;" title="${val}"></div>`;
              })
              .join('');

            modalBody.innerHTML = `
            <div style="margin-bottom: 20px;">
              <strong>Period:</strong> ${response.period}<br>
              <strong>Date Range:</strong> ${response.dateRange}<br>
              <strong>Total Entries:</strong> ${response.totalEntries}
            </div>

            <h3 style="margin: 20px 0 12px;">Aggregations</h3>
            <div class="stats-overview">
              ${aggregations}
            </div>

            <h3 style="margin: 20px 0 12px;">Activity Chart</h3>
            <div class="chart-container" style="display: flex; align-items: flex-end; gap: 4px; padding: 20px;">
              ${chartBars || '<p style="color: var(--text-secondary); text-align: center; width: 100%;">No data to display</p>'}
            </div>
          `;
          }

          trackerModal.classList.add('active');
        } catch (error) {
          toast.error('Failed to load stats');
        }
      };

      // View tracker history
      window.viewTrackerHistory = async (name) => {
        try {
          const response = await api.get(`/trackers/${name}/history?limit=50`);
          const records = response.records || [];

          modalTitle.innerHTML = `üìú History for ${response.tracker}`;

          const recordsHtml = records
            .map((record) => {
              const dataItems = Object.entries(record.data || {})
                .map(
                  ([key, value]) =>
                    `<span class="record-data-item"><strong>${key}:</strong> ${value}</span>`,
                )
                .join('');

              return `
            <div class="record-item">
              <span class="record-date">${new Date(record.date).toLocaleDateString()} ${new Date(record.timestamp).toLocaleTimeString()}</span>
              <div class="record-data">${dataItems}</div>
            </div>
          `;
            })
            .join('');

          modalBody.innerHTML = `
          <p style="margin-bottom: 16px;">Showing ${records.length} entries</p>
          <div class="records-list">
            ${recordsHtml || '<p style="color: var(--text-secondary);">No entries found.</p>'}
          </div>
        `;

          trackerModal.classList.add('active');
        } catch (error) {
          toast.error('Failed to load history');
        }
      };

      // Delete tracker
      window.deleteTracker = async (name) => {
        if (
          !confirm(
            `Are you sure you want to delete the tracker "${name}"? This cannot be undone.`,
          )
        ) {
          return;
        }

        try {
          await api.delete(`/trackers/${name}`);
          toast.success('Tracker deleted');
          loadTrackers();
          trackerModal.classList.remove('active');
        } catch (error) {
          toast.error('Failed to delete tracker');
        }
      };

      // Modal close handlers
      document.getElementById('modal-close').addEventListener('click', () => {
        trackerModal.classList.remove('active');
      });

      document
        .getElementById('create-modal-close')
        .addEventListener('click', () => {
          createModal.classList.remove('active');
        });

      document.getElementById('cancel-create').addEventListener('click', () => {
        createModal.classList.remove('active');
      });

      // Close modal on outside click
      trackerModal.addEventListener('click', (e) => {
        if (e.target === trackerModal) {
          trackerModal.classList.remove('active');
        }
      });

      createModal.addEventListener('click', (e) => {
        if (e.target === createModal) {
          createModal.classList.remove('active');
        }
      });

      // Create tracker
      document
        .getElementById('create-tracker-btn')
        .addEventListener('click', () => {
          createModal.classList.add('active');
        });

      // Type selector
      document.querySelectorAll('.type-option').forEach((option) => {
        option.addEventListener('click', () => {
          document
            .querySelectorAll('.type-option')
            .forEach((o) => o.classList.remove('selected'));
          option.classList.add('selected');
        });
      });

      // Create tracker form
      document
        .getElementById('create-tracker-form')
        .addEventListener('submit', async (e) => {
          e.preventDefault();

          const selectedType =
            document.querySelector('.type-option.selected')?.dataset.type ||
            'custom';
          const name = document.getElementById('tracker-name').value;
          const displayName = document.getElementById(
            'tracker-display-name',
          ).value;
          const metricsInput = document.getElementById('tracker-metrics').value;
          const metrics = metricsInput
            .split(',')
            .map((m) => m.trim())
            .filter((m) => m);

          try {
            await api.post('/trackers', {
              name,
              displayName,
              type: selectedType,
              metrics,
            });

            toast.success('Tracker created successfully');
            createModal.classList.remove('active');
            loadTrackers();

            // Reset form
            document.getElementById('create-tracker-form').reset();
            document
              .querySelectorAll('.type-option')
              .forEach((o) => o.classList.remove('selected'));
          } catch (error) {
            toast.error(error.message || 'Failed to create tracker');
          }
        });

      // Initial load
      loadTrackers();

      // Refresh on WebSocket events
      api.on('trackerCreated', () => loadTrackers());
      api.on('trackerDeleted', () => loadTrackers());
      api.on('trackerRecordAdded', () => loadTrackers());
    </script>
  </body>
</html>
