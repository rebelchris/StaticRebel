<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Logs - Ollama Assistant</title>
    <link rel="stylesheet" href="/css/style.css" />
    <style>
      .log-entry {
        display: grid;
        grid-template-columns: 180px 120px 1fr;
        gap: 12px;
        padding: 10px 16px;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.9rem;
        align-items: start;
      }
      .log-entry:last-child {
        border-bottom: none;
      }
      .log-entry:hover {
        background: var(--bg-tertiary);
      }
      .log-timestamp {
        color: var(--text-muted);
        font-family: monospace;
        font-size: 0.85rem;
      }
      .log-message {
        color: var(--text-primary);
        word-break: break-word;
      }
      .log-metadata {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 4px;
      }
      .log-type {
        font-weight: 500;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        text-align: center;
        display: inline-block;
      }
      .log-type.telegram-in {
        background: rgba(139, 92, 246, 0.2);
        color: #a78bfa;
      }
      .log-type.telegram-out {
        background: rgba(59, 130, 246, 0.2);
        color: #60a5fa;
      }
      .log-type.telegram-error {
        background: rgba(239, 68, 68, 0.2);
        color: #f87171;
      }
      .log-type.system {
        background: rgba(100, 116, 139, 0.2);
        color: #94a3b8;
      }
      .log-type.error {
        background: rgba(239, 68, 68, 0.2);
        color: #f87171;
      }
      .log-controls {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .log-controls .form-select,
      .log-controls .form-input {
        min-width: 150px;
      }
      .log-container {
        max-height: 600px;
        overflow-y: auto;
      }
      .log-container.paused {
        opacity: 0.7;
      }
      .auto-scroll-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
        color: var(--text-secondary);
      }
      .auto-scroll-indicator.active {
        color: var(--success-color);
      }
      .stats-bar {
        display: flex;
        gap: 20px;
        padding: 12px 16px;
        background: var(--bg-tertiary);
        border-radius: var(--border-radius);
        margin-bottom: 16px;
        font-size: 0.9rem;
      }
      .stats-bar .stat {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .stats-bar .stat-value {
        font-weight: 600;
        color: var(--text-primary);
      }
      .stats-bar .stat-label {
        color: var(--text-secondary);
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <aside class="sidebar">
        <div class="sidebar-header">
          <a href="/" class="sidebar-logo">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M12 2L2 7l10 5 10-5-10-5z" />
              <path d="M2 17l10 5 10-5" />
              <path d="M2 12l10 5 10-5" />
            </svg>
            Ollama Assistant
          </a>
        </div>
        <nav>
          <ul class="sidebar-nav">
            <li>
              <a href="/">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <rect x="3" y="3" width="7" height="7" />
                  <rect x="14" y="3" width="7" height="7" />
                  <rect x="14" y="14" width="7" height="7" />
                  <rect x="3" y="14" width="7" height="7" />
                </svg>
                Dashboard
              </a>
            </li>
            <li>
              <a href="/personas">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                  <circle cx="12" cy="7" r="4" />
                </svg>
                Personas
              </a>
            </li>
            <li>
              <a href="/memory">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                </svg>
                Memory
              </a>
            </li>
            <li>
              <a href="/workers">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
                  <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
                </svg>
                Workers
              </a>
            </li>
            <li>
              <a href="/trackers">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                  />
                </svg>
                Trackers
              </a>
            </li>
            <li>
              <a href="/logs" class="active">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                  <polyline points="14 2 14 8 20 8" />
                  <line x1="16" y1="13" x2="8" y2="13" />
                  <line x1="16" y1="17" x2="8" y2="17" />
                  <polyline points="10 9 9 9 8 9" />
                </svg>
                Logs
              </a>
            </li>
            <li>
              <a href="/apis">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M18 20V10" />
                  <path d="M12 20V4" />
                  <path d="M6 20v-6" />
                </svg>
                APIs
              </a>
            </li>
            <li>
              <a href="/chat">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                  />
                </svg>
                Chat
              </a>
            </li>
            <li>
              <a href="/config">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="12" cy="12" r="3" />
                  <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                  />
                </svg>
                Config
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      <main class="main-content">
        <div class="page-header">
          <h1 class="page-title">System Logs</h1>
          <p class="page-subtitle">View Telegram messages and system events</p>
        </div>

        <div class="action-bar">
          <div class="log-controls">
            <select class="form-select" id="type-filter">
              <option value="">All Types</option>
              <option value="telegram-in">Telegram In</option>
              <option value="telegram-out">Telegram Out</option>
              <option value="telegram-error">Telegram Error</option>
              <option value="system">System</option>
            </select>
            <input
              type="text"
              class="form-input"
              id="search-filter"
              placeholder="Search logs..."
            />
            <select class="form-select" id="days-filter">
              <option value="1">Today</option>
              <option value="3">Last 3 days</option>
              <option value="7">Last 7 days</option>
            </select>
          </div>
          <div style="display: flex; gap: 12px; align-items: center;">
            <div class="auto-scroll-indicator" id="auto-scroll-indicator">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
              <span>Auto-scroll</span>
            </div>
            <button class="btn btn-secondary" id="pause-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                <rect x="6" y="4" width="4" height="16"/>
                <rect x="14" y="4" width="4" height="16"/>
              </svg>
              Pause
            </button>
            <button class="btn btn-secondary" id="refresh-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                <polyline points="23 4 23 10 17 10"/>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
              </svg>
              Refresh
            </button>
            <button class="btn btn-danger" id="clear-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              </svg>
              Clear Old
            </button>
          </div>
        </div>

        <div class="stats-bar" id="stats-bar">
          <div class="stat">
            <span class="stat-label">Total:</span>
            <span class="stat-value" id="stat-total">0</span>
          </div>
          <div class="stat">
            <span class="stat-label">Telegram In:</span>
            <span class="stat-value" id="stat-telegram-in">0</span>
          </div>
          <div class="stat">
            <span class="stat-label">Telegram Out:</span>
            <span class="stat-value" id="stat-telegram-out">0</span>
          </div>
          <div class="stat">
            <span class="stat-label">Errors:</span>
            <span class="stat-value" id="stat-errors">0</span>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Log Entries</h3>
            <span id="log-count" style="color: var(--text-secondary); font-size: 0.9rem;">Loading...</span>
          </div>
          <div class="log-container" id="log-container">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </div>
      </main>
    </div>

    <script type="module">
      import { api } from '/js/api.js';
      import { format, toast, initPage } from '/js/shared.js';

      initPage('logs');

      const logContainer = document.getElementById('log-container');
      const logCount = document.getElementById('log-count');
      const typeFilter = document.getElementById('type-filter');
      const searchFilter = document.getElementById('search-filter');
      const daysFilter = document.getElementById('days-filter');
      const pauseBtn = document.getElementById('pause-btn');
      const refreshBtn = document.getElementById('refresh-btn');
      const clearBtn = document.getElementById('clear-btn');
      const autoScrollIndicator = document.getElementById('auto-scroll-indicator');

      let isPaused = false;
      let autoScroll = true;
      let lastTimestamp = null;
      let refreshInterval = null;

      function formatTimestamp(ts) {
        const date = new Date(ts);
        return date.toLocaleString('en-US', {
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        });
      }

      function getTypeClass(type) {
        return type || 'system';
      }

      function renderLogEntry(log) {
        const metadata = log.metadata && Object.keys(log.metadata).length > 0
          ? `<div class="log-metadata">${Object.entries(log.metadata).map(([k, v]) => `${k}: ${v}`).join(' | ')}</div>`
          : '';

        return `
          <div class="log-entry">
            <span class="log-timestamp">${formatTimestamp(log.timestamp)}</span>
            <span class="log-type ${getTypeClass(log.type)}">${log.type}</span>
            <div>
              <div class="log-message">${escapeHtml(log.message)}</div>
              ${metadata}
            </div>
          </div>
        `;
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      async function loadLogs() {
        if (isPaused) return;

        try {
          const params = new URLSearchParams({
            limit: '200',
            days: daysFilter.value
          });

          if (typeFilter.value) params.append('type', typeFilter.value);
          if (searchFilter.value) params.append('search', searchFilter.value);

          const response = await fetch(`/api/logs?${params}`);
          const data = await response.json();

          renderLogs(data.logs);
          updateStats(data.stats);
          logCount.textContent = `${data.count} entries`;

          // Track newest timestamp for WebSocket updates
          if (data.logs.length > 0) {
            lastTimestamp = data.logs[0].timestamp;
          }
        } catch (error) {
          console.error('Failed to load logs:', error);
          logContainer.innerHTML = '<p class="text-muted" style="text-align: center; padding: 40px;">Failed to load logs</p>';
        }
      }

      function renderLogs(logs) {
        if (logs.length === 0) {
          logContainer.innerHTML = `
            <div class="empty-state">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
              </svg>
              <h3>No logs found</h3>
              <p>Logs will appear here when Telegram messages are sent or received</p>
            </div>
          `;
          return;
        }

        // Reverse to show oldest first, then scroll to bottom
        const reversed = [...logs].reverse();
        logContainer.innerHTML = reversed.map(renderLogEntry).join('');

        if (autoScroll) {
          logContainer.scrollTop = logContainer.scrollHeight;
        }
      }

      function updateStats(stats) {
        if (!stats) return;
        document.getElementById('stat-total').textContent = stats.totalEntries || 0;
        document.getElementById('stat-telegram-in').textContent = stats.byType?.['telegram-in'] || 0;
        document.getElementById('stat-telegram-out').textContent = stats.byType?.['telegram-out'] || 0;
        document.getElementById('stat-errors').textContent =
          (stats.byType?.['telegram-error'] || 0) + (stats.byLevel?.['error'] || 0);
      }

      function appendLog(log) {
        if (isPaused) return;

        // Check if log passes current filters
        if (typeFilter.value && log.type !== typeFilter.value) return;
        if (searchFilter.value && !log.message?.toLowerCase().includes(searchFilter.value.toLowerCase())) return;

        const entry = document.createElement('div');
        entry.innerHTML = renderLogEntry(log);
        logContainer.appendChild(entry.firstElementChild);

        if (autoScroll) {
          logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Update count
        const currentCount = parseInt(logCount.textContent) || 0;
        logCount.textContent = `${currentCount + 1} entries`;
      }

      // Pause/Resume
      pauseBtn.addEventListener('click', () => {
        isPaused = !isPaused;
        pauseBtn.innerHTML = isPaused
          ? `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polygon points="5 3 19 12 5 21 5 3"/></svg> Resume`
          : `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg> Pause`;
        logContainer.classList.toggle('paused', isPaused);

        if (!isPaused) loadLogs();
      });

      // Refresh
      refreshBtn.addEventListener('click', loadLogs);

      // Clear old logs
      clearBtn.addEventListener('click', async () => {
        if (!confirm('Delete logs older than 7 days?')) return;

        try {
          const response = await fetch('/api/logs?olderThanDays=7', { method: 'DELETE' });
          const data = await response.json();
          toast.success(`Deleted ${data.deleted} log file(s)`);
          loadLogs();
        } catch (error) {
          toast.error('Failed to clear logs');
        }
      });

      // Filter changes
      typeFilter.addEventListener('change', loadLogs);
      daysFilter.addEventListener('change', loadLogs);

      let searchTimeout;
      searchFilter.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(loadLogs, 300);
      });

      // Auto-scroll toggle on manual scroll
      logContainer.addEventListener('scroll', () => {
        const atBottom = logContainer.scrollHeight - logContainer.scrollTop - logContainer.clientHeight < 50;
        autoScroll = atBottom;
        autoScrollIndicator.classList.toggle('active', autoScroll);
      });

      // WebSocket for real-time updates
      api.on('log', (data) => {
        appendLog(data);
      });

      // Also listen for telegram-specific events that might broadcast logs
      api.on('telegram', (data) => {
        if (data.log) appendLog(data.log);
      });

      // Periodic refresh (every 5 seconds) as fallback
      refreshInterval = setInterval(() => {
        if (!isPaused) loadLogs();
      }, 5000);

      // Initial load
      loadLogs();
    </script>
  </body>
</html>
